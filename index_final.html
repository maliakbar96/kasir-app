<!-- Index Modern Kasir + Fitur Pencarian & Input Barang Manual + Toggle Tabel Produk + Tombol Backup -->
<!DOCTYPE html>
<html>
<head>
  <title>Kasir Modern</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #f3f4f6; }
    .header { background: #007bff; color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; }
    .layout { display: flex; height: calc(100vh - 60px); }
    .sidebar { background: #fff; width: 300px; padding: 1rem; box-shadow: 2px 0 5px rgba(0,0,0,0.1); overflow-y: auto; }
    .main { flex: 1; padding: 1rem; overflow-y: auto; }
    .btn { padding: 10px; border: none; border-radius: 6px; margin-top: 5px; width: 100%; }
    .btn-primary { background-color: #007bff; color: white; }
    .btn-success { background-color: #28a745; color: white; }
    .btn-danger { background-color: #dc3545; color: white; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    th { background-color: #f1f1f1; }
    .total-preview { margin-top: 10px; font-weight: bold; color: #2c3e50; }
    .search-box { margin-top: 1rem; }
    .search-box input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 6px; }
  </style>
</head>
<body>
  <div class="header">
    <h2>üõí Kasir Toko</h2>
    <div style="display: flex; gap: 10px;">
      <a class="btn btn-danger" href="/backup_produk">üóÇÔ∏è Backup Produk</a>
      <button class="btn btn-primary" onclick="toggleDarkMode()">üåô Dark Mode</button>
      <a class="btn btn-success" href="/download_produk">üì¶ Download Produk</a>
    </div>
  </div>

  <div class="layout">
    <div class="sidebar">
      <h3>üîç Cari Produk</h3>
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="Cari nama produk..." oninput="filterProduk()">
      </div>

      <button class="btn btn-primary" onclick="toggleTabelProduk()">üëÅÔ∏è Tampilkan/Sembunyikan Produk</button>
      <div id="tabelProdukWrapper" style="display: none;">
        <table id="produkTable">
          <thead><tr><th>Nama</th><th>Harga</th><th>Aksi</th></tr></thead>
          <tbody>
            {% for produk in produk_list %}
            <tr>
              <td>{{ produk.nama }}</td>
              <td>Rp{{ produk.harga }}</td>
              <td>
                <a href="{{ url_for('edit_produk', idx=loop.index0) }}">‚úèÔ∏è</a>
                <a href="{{ url_for('hapus_produk', idx=loop.index0) }}" onclick="return confirm('Hapus produk ini?')">üóëÔ∏è</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <hr>
      <h3>‚ûï Tambah Produk</h3>
      <form method="POST">
        <input type="text" name="nama_produk_baru" placeholder="Nama Produk" required><br>
        <input type="number" name="harga_produk_baru" placeholder="Harga" required><br>
        <button type="submit" name="tambah_produk" class="btn btn-primary">Tambah</button>
      </form>
    </div>

    <div class="main">
      <h3>üßæ Transaksi</h3>
      <form method="POST">
        <div id="produk-container">
          <div class="produk-row">
            <input list="produkList" name="produk[]" placeholder="Ketik nama produk..." oninput="hitungTotal()" required>
            <datalist id="produkList">
              {% for produk in produk_list %}
                <option value="{{ produk.nama }}">
              {% endfor %}
            </datalist>
            <input type="number" name="jumlah[]" placeholder="Jumlah" required oninput="hitungTotal()">
          </div>
        </div>
        <button type="button" class="btn btn-primary" onclick="tambahBarang()">+ Tambah Produk</button>

        <h4>Input Manual</h4>
        <div id="manual-container">
          <div class="manual-row">
            <input type="text" name="manual_nama[]" placeholder="Nama">
            <input type="number" name="manual_harga[]" placeholder="Harga" oninput="hitungTotal()">
            <input type="number" name="manual_jumlah[]" placeholder="Jumlah" oninput="hitungTotal()">
          </div>
        </div>
        <button type="button" class="btn btn-success" onclick="tambahManual()">+ Tambah Manual</button>

        <div class="total-preview" id="previewTotal">Total: Rp0</div>

        <input type="number" name="bayar" placeholder="Uang Bayar" required>
        <button type="submit" class="btn btn-primary">Bayar</button>

        {% if total_tagihan is defined %}
          <div><strong>Total: Rp{{ total_tagihan }}</strong></div>
        {% endif %}
        {% if kembalian is not none %}
          <div><strong>Kembalian: Rp{{ kembalian }}</strong></div>
        {% endif %}
        {% if error %}
          <div style="color: red">{{ error }}</div>
        {% endif %}
      </form>

      <h3>üìñ Riwayat Transaksi</h3>
      <table>
        <thead>
          <tr><th>Produk</th><th>Jumlah</th><th>Total</th><th>Waktu</th></tr>
        </thead>
        <tbody>
          {% for transaksi in transaksi_list %}
          <tr>
            <td>{{ transaksi["produk"] }}</td>
            <td>{{ transaksi["jumlah"] }}</td>
            <td>Rp{{ transaksi["total"] }}</td>
            <td>{{ transaksi["waktu"] }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <script>
    function tambahBarang() {
      const container = document.getElementById('produk-container');
      const row = container.firstElementChild.cloneNode(true);
      row.querySelectorAll('input').forEach(input => {
        input.value = '';
        input.addEventListener('input', hitungTotal);
      });
      container.appendChild(row);
    }
    function tambahManual() {
      const container = document.getElementById('manual-container');
      const row = container.firstElementChild.cloneNode(true);
      row.querySelectorAll('input').forEach(input => {
        input.value = '';
        input.addEventListener('input', hitungTotal);
      });
      container.appendChild(row);
    }
    function toggleDarkMode() {
      document.body.classList.toggle("dark-mode");
    }
    function toggleTabelProduk() {
      const wrapper = document.getElementById('tabelProdukWrapper');
      wrapper.style.display = wrapper.style.display === 'none' ? 'block' : 'none';
    }
    function filterProduk() {
      const input = document.getElementById("searchInput");
      const filter = input.value.toLowerCase();
      const table = document.getElementById("produkTable");
      const tr = table.getElementsByTagName("tr");
      for (let i = 1; i < tr.length; i++) {
        const td = tr[i].getElementsByTagName("td")[0];
        if (td) {
          const txtValue = td.textContent || td.innerText;
          tr[i].style.display = txtValue.toLowerCase().indexOf(filter) > -1 ? "" : "none";
        }
      }
    }
    function hitungTotal() {
      let total = 0;
      const produkData = {
        {% for produk in produk_list %}"{{ produk.nama }}": {{ produk.harga }}{% if not loop.last %}, {% endif %}{% endfor %}
      };
      document.querySelectorAll('#produk-container .produk-row').forEach(row => {
        const nama = row.querySelector('input[name="produk[]"]').value;
        const jumlah = parseInt(row.querySelector('input[name="jumlah[]"]').value || 0);
        const harga = produkData[nama] || 0;
        total += harga * jumlah;
      });
      document.querySelectorAll('#manual-container .manual-row').forEach(row => {
        const harga = parseInt(row.querySelector('[name="manual_harga[]"]').value || 0);
        const jumlah = parseInt(row.querySelector('[name="manual_jumlah[]"]').value || 0);
        total += harga * jumlah;
      });
      document.getElementById('previewTotal').textContent = "Total: Rp" + total.toLocaleString();
    }
    window.onload = hitungTotal;
  </script>
</body>
</html>
